<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sản phẩm học viên</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        p, h4, small, td, th {
            word-break: break-word;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: scale(1.05);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            min-height: 500px;
        }

        .search-container {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 18px;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .clear-filters-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: white;
            border-color: #667eea;
        }

        .search-stats {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .class-grid-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .class-section-title {
            margin-top: 30px;
            color: #333;
        }

        .class-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .class-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .class-card:hover::before {
            animation: shine 0.6s ease-in-out;
            opacity: 1;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .class-card h3 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .class-card p {
            color: #666;
            font-size: 1.1em;
        }

        .student-count {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 15px;
            display: inline-block;
            font-weight: bold;
            color: #333;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95e1d3, #fce38a);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .student-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .student-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .student-class-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .product-count {
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .highlight {
            background: rgba(255, 235, 59, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .no-results i {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
            opacity: 0.5;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product-table th,
        .product-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: normal;
            word-break: break-word;
        }

        .product-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .product-table tr:hover {
            background: #f8f9ff;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .back-btn {
            background: linear-gradient(45deg, #95e1d3, #a8edea);
            color: #333;
            margin-bottom: 20px;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .storage-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            transform: translateY(100px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .storage-status.show {
            transform: translateY(0);
        }

        .storage-status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .comment-box {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .class-grid-section {
                grid-template-columns: 1fr;
            }

            .nav {
                flex-direction: column;
            }

            .actions {
                flex-direction: column;
            }

            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-item {
                justify-content: space-between;
            }

            .product-table {
                font-size: 14px;
            }

            .product-table th,
            .product-table td {
                padding: 10px 5px;
            }
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Quản lý sản phẩm học viên</h1>
            <div class="nav">
                <button class="nav-btn active" onclick="showHome()">🏠 Trang chủ</button>
                <button class="nav-btn" onclick="showAllStudents()">👥 Tất cả học viên</button>
                <button class="nav-btn" onclick="showSearchPage()">🔍 Tìm kiếm</button>
                <button class="nav-btn" onclick="showAddClassModal()">➕ Thêm lớp</button>
                <button class="nav-btn" onclick="exportData()">📊 Xuất Excel</button>
                <button class="nav-btn" onclick="showImportModal()">📁 Nhập Excel</button>
            </div>
        </div>

        <div class="content">
            <!-- Trang chủ -->
            <div id="home-page">
                <div class="actions" style="margin-bottom: 20px;">
                    <button class="btn" onclick="showAddClassModal()">➕ Thêm lớp học mới</button>
                    <button class="btn btn-secondary" onclick="showFormatGuide()">📋 Hướng dẫn Excel</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Xóa tất cả dữ liệu</button>
                </div>
                <h2>Các lớp học đang giảng dạy</h2>
                <div id="class-grid"></div>
            </div>

            <!-- Trang tìm kiếm -->
            <div id="search-page" class="hidden">
                <h2>🔍 Tìm kiếm học viên</h2>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="search-input"
                            placeholder="Nhập tên học viên, email hoặc thông tin cần tìm..." oninput="performSearch()">
                        <span class="search-icon">🔍</span>
                    </div>
                    <div class="search-filters">
                        <div class="filter-item">
                            <label style="color: #333; font-weight: bold;">Lọc theo lớp:</label>
                            <select id="search-class-filter" class="filter-select" onchange="performSearch()">
                                <option value="">Tất cả lớp</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label style="color: #333; font-weight: bold;">Sản phẩm:</label>
                            <select id="search-product-filter" class="filter-select" onchange="performSearch()">
                                <option value="">Tất cả</option>
                                <option value="with-products">Có sản phẩm</option>
                                <option value="no-products">Chưa có sản phẩm</option>
                            </select>
                        </div>
                        <button class="clear-filters-btn" onclick="clearSearchFilters()">Xóa bộ lọc</button>
                    </div>
                    <div class="search-stats" id="search-stats"></div>
                </div>
                <div id="search-results" class="student-list"></div>
            </div>

            <!-- Trang lớp học -->
            <div id="class-page" class="hidden">
                <button class="btn back-btn" onclick="showHome()">← Quay lại</button>
                <div class="actions">
                    <button class="btn" onclick="showAddStudentForm()">➕ Thêm học viên</button>
                    <button class="btn btn-secondary" onclick="exportClassData()">📊 Xuất dữ liệu lớp</button>
                    <button class="btn" onclick="showImportModal()">📁 Nhập Excel lớp</button>
                </div>
                <h2 id="class-title"></h2>
                <div id="class-comment-section">
                    <h3>Nhận xét lớp</h3>
                    <textarea id="class-comment" class="comment-box"></textarea>
                    <button class="btn" onclick="saveClassComment()">Lưu nhận xét</button>
                </div>
                <div id="students-list" class="student-list"></div>
            </div>

            <!-- Trang sản phẩm học viên -->
            <div id="student-page" class="hidden">
                <button class="btn back-btn" onclick="goBackToClass()">← Quay lại lớp</button>
                <div class="actions">
                    <button class="btn" onclick="showAddProductForm()">➕ Thêm sản phẩm</button>
                    <button class="btn btn-secondary" onclick="exportStudentData()">📊 Xuất dữ liệu học viên</button>
                </div>
                <h2 id="student-title"></h2>
                <div id="products-container">
                    <table class="product-table" id="products-table">
                        <thead>
                            <tr>
                                <th>Buổi học</th>
                                <th>Tên sản phẩm</th>
                                <th>Ý tưởng</th>
                                <th>Nhiệm vụ buổi học</th>
                                <th>Nhiệm vụ về nhà</th>
                                <th>Tiến độ</th>
                                <th>Góp ý</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Trang tất cả học viên -->
            <div id="all-students-page" class="hidden">
                <button class="btn back-btn" onclick="showHome()">← Quay lại</button>
                <h2>Tất cả học viên</h2>
                <div id="all-students-list" class="student-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal thêm lớp học -->
    <div id="add-class-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-class-modal')">&times;</span>
            <h3>Thêm lớp học mới</h3>
            <div class="form-container">
                <div class="form-group">
                    <label for="class-code">Mã lớp:</label>
                    <input type="text" id="class-code" placeholder="Ví dụ: PTI06, JSB06" required>
                </div>
                <div class="form-group">
                    <label for="class-name">Tên lớp:</label>
                    <input type="text" id="class-name" placeholder="Ví dụ: Lập trình Python nâng cao" required>
                </div>
                <div class="form-group">
                    <label for="class-type">Loại lớp:</label>
                    <select id="class-type">
                        <option value="coding">Coding</option>
                        <option value="robotic">Robotic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="class-description">Mô tả:</label>
                    <textarea id="class-description" placeholder="Mô tả ngắn về lớp học"></textarea>
                </div>
                <button class="btn" onclick="addClass()">Thêm lớp</button>
            </div>
        </div>
    </div>

    <!-- Modal thêm học viên -->
    <div id="add-student-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-student-modal')">&times;</span>
            <h3>Thêm học viên mới</h3>
            <div class="form-container">
                <div class="form-group">
                    <label for="student-name">Tên học viên:</label>
                    <input type="text" id="student-name" required>
                </div>
                <div class="form-group">
                    <label for="student-email">Email:</label>
                    <input type="email" id="student-email">
                </div>
                <div class="form-group">
                    <label for="student-phone">Số điện thoại:</label>
                    <input type="tel" id="student-phone">
                </div>
                <button class="btn" onclick="addStudent()">Thêm học viên</button>
            </div>
        </div>
    </div>

    <!-- Modal thêm/sửa sản phẩm -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add-product-modal')">&times;</span>
            <h3 id="product-modal-title">Thêm sản phẩm mới</h3>
            <div class="form-container">
                <div class="form-group">
                    <label for="product-session">Buổi học:</label>
                    <input type="number" id="product-session" min="1" required>
                </div>
                <div class="form-group">
                    <label for="product-name">Tên sản phẩm:</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-idea">Ý tưởng:</label>
                    <textarea id="product-idea"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-class-task">Nhiệm vụ buổi học:</label>
                    <textarea id="product-class-task"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-homework">Nhiệm vụ về nhà:</label>
                    <textarea id="product-homework"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-progress">Tiến độ hoàn thành (%):</label>
                    <input type="number" id="product-progress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="product-feedback">Góp ý:</label>
                    <textarea id="product-feedback"></textarea>
                </div>
                <button class="btn" onclick="saveProduct()" id="save-product-btn">Thêm sản phẩm</button>
            </div>
        </div>
    </div>

    <!-- Modal nhập Excel -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('import-modal')">&times;</span>
            <h3>Nhập dữ liệu từ Excel</h3>
            <div class="form-container">
                <div class="form-group">
                    <label for="excel-file">Chọn file Excel:</label>
                    <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                </div>
                <div class="form-group">
                    <label for="import-class">Chọn lớp để nhập:</label>
                    <select id="import-class"></select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="overwrite-data"> Ghi đè dữ liệu cũ
                    </label>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Nếu không chọn, dữ liệu mới sẽ được thêm vào dữ liệu hiện có
                    </small>
                </div>
                <div id="preview-container" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
                <button class="btn" onclick="importData()" id="import-btn" disabled>Nhập dữ liệu</button>
            </div>
        </div>
    </div>

    <!-- Modal hướng dẫn format Excel -->
    <div id="format-guide-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('format-guide-modal')">&times;</span>
            <h3>Hướng dẫn định dạng file Excel</h3>
            <div style="text-align: left;">
                <h4>Định dạng cột trong Excel:</h4>
                <table class="product-table" style="margin: 15px 0;">
                    <thead>
                        <tr>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>E</th>
                            <th>F</th>
                            <th>G</th>
                            <th>H</th>
                            <th>I</th>
                            <th>J</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Tên học viên</td>
                            <td>Email</td>
                            <td>Số điện thoại</td>
                            <td>Buổi học</td>
                            <td>Tên sản phẩm</td>
                            <td>Ý tưởng</td>
                            <td>Nhiệm vụ buổi học</td>
                            <td>Nhiệm vụ về nhà</td>
                            <td>Tiến độ (%)</td>
                            <td>Góp ý</td>
                        </tr>
                        <tr>
                            <td>Nguyễn Văn A</td>
                            <td>email@test.com</td>
                            <td>0123456789</td>
                            <td>1</td>
                            <td>Calculator App</td>
                            <td>Ứng dụng tính toán</td>
                            <td>Học Python cơ bản</td>
                            <td>Hoàn thành giao diện</td>
                            <td>75</td>
                            <td>Làm tốt</td>
                        </tr>
                    </tbody>
                </table>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="color: #0066cc; margin-bottom: 10px;">📝 Lưu ý quan trọng:</h4>
                    <ul style="margin-left: 20px; color: #333;">
                        <li>Dòng đầu tiên phải là tiêu đề cột (header)</li>
                        <li>Nếu học viên không có sản phẩm, để trống các cột từ D đến J</li>
                        <li>Một học viên có thể có nhiều sản phẩm (nhiều dòng)</li>
                        <li>Tiến độ phải là số từ 0-100</li>
                        <li>Buổi học phải là số nguyên dương</li>
                        <li>Hỗ trợ file .xlsx và .xls</li>
                    </ul>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="downloadTemplate()">📥 Tải file mẫu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Status -->
    <div id="storage-status" class="storage-status">
        💾 Đã lưu
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Dữ liệu mẫu và biến toàn cục
        let data = {};
        let classInfo = {};
        let currentClass = '';
        let currentStudent = '';
        let editingProductIndex = -1;
        let pendingImportData = null;
        let searchResults = [];

        // ======================== LOCALSTORAGE FUNCTIONS ========================

        // Key để lưu trong localStorage
        const STORAGE_KEYS = {
            DATA: 'student_management_data',
            CLASS_INFO: 'student_management_class_info',
            RECENT_SEARCHES: 'student_management_recent_searches'
        };

        // Cấu hình Google Sheets (cần thay bằng thông tin thật)
        const GOOGLE_SHEET_CONFIG = {
            apiKey: 'YOUR_API_KEY',
            clientId: 'YOUR_CLIENT_ID',
            spreadsheetId: 'YOUR_SPREADSHEET_ID'
        };

        // Lưu dữ liệu vào localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(data));
                localStorage.setItem(STORAGE_KEYS.CLASS_INFO, JSON.stringify(classInfo));
                showStorageStatus('💾 Đã lưu', false);
                console.log('Dữ liệu đã được lưu vào localStorage');
                saveToGoogleSheet();
            } catch (error) {
                console.error('Lỗi khi lưu vào localStorage:', error);
                showStorageStatus('❌ Lỗi lưu trữ', true);
            }
        }

        // Tải dữ liệu từ localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.DATA);
                const savedClassInfo = localStorage.getItem(STORAGE_KEYS.CLASS_INFO);

                if (savedData) {
                    data = JSON.parse(savedData);
                    console.log('Đã tải dữ liệu học viên từ localStorage');
                }

                if (savedClassInfo) {
                    classInfo = JSON.parse(savedClassInfo);
                    console.log('Đã tải thông tin lớp từ localStorage');
                }

                // Nếu không có dữ liệu trong localStorage, khởi tạo dữ liệu mặc định
                if (Object.keys(classInfo).length === 0) {
                    initDefaultClasses();
                    initSampleData();
                    saveToLocalStorage();
                }

                return true;
            } catch (error) {
                console.error('Lỗi khi tải từ localStorage:', error);
                showStorageStatus('❌ Lỗi tải dữ liệu', true);
                // Khởi tạo dữ liệu mặc định nếu có lỗi
                initDefaultClasses();
                initSampleData();
                return false;
            }
        }

        // Hiển thị trạng thái lưu trữ
        function showStorageStatus(message, isError = false) {
            const statusElement = document.getElementById('storage-status');
            statusElement.textContent = message;
            statusElement.className = `storage-status show ${isError ? 'error' : ''}`;

            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 2000);
        }

        // ======================== GOOGLE SHEETS FUNCTIONS ========================
        function initGoogleSheets() {
            if (typeof gapi === 'undefined') {
                console.warn('Google API not loaded');
                return;
            }
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: GOOGLE_SHEET_CONFIG.apiKey,
                    clientId: GOOGLE_SHEET_CONFIG.clientId,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                    scope: "https://www.googleapis.com/auth/spreadsheets"
                }).then(loadFromGoogleSheet);
            });
        }

        function loadFromGoogleSheet() {
            // TODO: Tải dữ liệu từ Google Sheets và cập nhật vào ứng dụng
            console.log('Loading data from Google Sheets...');
        }

        function saveToGoogleSheet() {
            // TODO: Đồng bộ dữ liệu ứng dụng lên Google Sheets
            console.log('Saving data to Google Sheets...');
        }

        // Xóa tất cả dữ liệu
        function clearAllData() {
            if (confirm('⚠️ Bạn có chắc chắn muốn xóa TẤT CẢ dữ liệu?\n\nHành động này không thể hoàn tác!')) {
                if (confirm('🚨 Xác nhận lần cuối: XÓA TẤT CẢ DỮ LIỆU?')) {
                    try {
                        // Xóa từ localStorage
                        localStorage.removeItem(STORAGE_KEYS.DATA);
                        localStorage.removeItem(STORAGE_KEYS.CLASS_INFO);
                        localStorage.removeItem(STORAGE_KEYS.RECENT_SEARCHES);

                        // Xóa từ memory
                        data = {};
                        classInfo = {};

                        // Khởi tạo lại dữ liệu mặc định
                        initDefaultClasses();
                        saveToLocalStorage();

                        // Cập nhật giao diện
                        updateStudentCounts();
                        renderClassGrid();
                        updateImportClassSelect();
                        updateSearchFilters();

                        showStorageStatus('🗑️ Đã xóa tất cả', false);
                        alert('✅ Đã xóa tất cả dữ liệu và khởi tạo lại!');
                    } catch (error) {
                        console.error('Lỗi khi xóa dữ liệu:', error);
                        showStorageStatus('❌ Lỗi xóa dữ liệu', true);
                    }
                }
            }
        }

        // Lưu tìm kiếm gần đây
        function saveRecentSearch(searchTerm) {
            if (!searchTerm.trim()) return;

            try {
                let recentSearches = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECENT_SEARCHES) || '[]');
                recentSearches = recentSearches.filter(term => term !== searchTerm);
                recentSearches.unshift(searchTerm);
                recentSearches = recentSearches.slice(0, 5);

                localStorage.setItem(STORAGE_KEYS.RECENT_SEARCHES, JSON.stringify(recentSearches));
            } catch (error) {
                console.error('Lỗi khi lưu tìm kiếm gần đây:', error);
            }
        }

        // ======================== INITIALIZATION FUNCTIONS ========================

        // Khởi tạo ứng dụng
        function init() {
            // Tải dữ liệu từ localStorage trước
            loadFromLocalStorage();

            updateStudentCounts();
            renderClassGrid();
            updateImportClassSelect();
            updateSearchFilters();

            initGoogleSheets();
            console.log('Ứng dụng đã được khởi tạo');
        }

        // Khởi tạo các lớp mặc định
        function initDefaultClasses() {
            classInfo = {
                'PTI03': { name: 'Lập trình Python cơ bản', description: 'Khóa học Python cho người mới bắt đầu', type: 'coding', comment: '' },
                'PTI04': { name: 'Lập trình Python nâng cao', description: 'Khóa học Python nâng cao', type: 'coding', comment: '' },
                'JSB05': { name: 'JavaScript cho người mới bắt đầu', description: 'Khóa học JavaScript cơ bản', type: 'coding', comment: '' },
                'RBT01': { name: 'Robotics cơ bản', description: 'Khóa học Robotics cơ bản', type: 'robotic', comment: '' }
            };

            // Khởi tạo data cho các lớp nếu chưa có
            Object.keys(classInfo).forEach(classCode => {
                if (!data[classCode]) {
                    data[classCode] = {};
                }
            });
        }

        // Khởi tạo dữ liệu mẫu
        function initSampleData() {
            // Chỉ thêm dữ liệu mẫu nếu chưa có dữ liệu
            if (Object.keys(data).length === 0 || Object.keys(data.PTI03 || {}).length === 0) {
                data.PTI03 = data.PTI03 || {};
                data.PTI03['Nguyễn Văn A'] = {
                    email: 'nguyenvana@email.com',
                    phone: '0123456789',
                    products: [
                        {
                            session: 1,
                            name: 'Calculator App',
                            idea: 'Tạo ứng dụng máy tính đơn giản',
                            classTask: 'Học syntax Python cơ bản',
                            homework: 'Hoàn thành phép cộng, trừ',
                            progress: 75,
                            feedback: 'Làm tốt, cần cải thiện giao diện'
                        },
                        {
                            session: 2,
                            name: 'To-Do List',
                            idea: 'Ứng dụng quản lý công việc',
                            classTask: 'Học về list và loop',
                            homework: 'Thêm chức năng xóa task',
                            progress: 50,
                            feedback: 'Cần thêm validation'
                        }
                    ]
                };

                data.PTI04 = data.PTI04 || {};
                data.PTI04['Trần Thị B'] = {
                    email: 'tranthib@email.com',
                    phone: '0987654321',
                    products: [
                        {
                            session: 1,
                            name: 'Web Scraper',
                            idea: 'Thu thập dữ liệu từ website',
                            classTask: 'Học BeautifulSoup',
                            homework: 'Scrape một trang tin tức',
                            progress: 90,
                            feedback: 'Rất tốt, code sạch và hiệu quả'
                        }
                    ]
                };

                data.JSB05 = data.JSB05 || {};
                data.JSB05['Lê Văn C'] = {
                    email: 'levanc@email.com',
                    phone: '0369852147',
                    products: [
                        {
                            session: 1,
                            name: 'Interactive Website',
                            idea: 'Trang web tương tác với JavaScript',
                            classTask: 'Học DOM manipulation',
                            homework: 'Thêm animation',
                            progress: 60,
                            feedback: 'Tốt, cần chú ý responsive design'
                        }
                    ]
                };

                // Thêm học viên không có sản phẩm
                data.PTI03['Phạm Thị D'] = {
                    email: 'phamthid@email.com',
                    phone: '0147258369',
                    products: []
                };

                data.JSB05['Hoàng Văn E'] = {
                    email: 'hoangvane@email.com',
                    phone: '0951753468',
                    products: []
                };
            }
        }

        // ======================== SEARCH FUNCTIONS ========================

        // Cập nhật bộ lọc tìm kiếm
        function updateSearchFilters() {
            const classSelect = document.getElementById('search-class-filter');
            classSelect.innerHTML = '<option value="">Tất cả lớp</option>';

            Object.keys(classInfo).forEach(classCode => {
                const option = document.createElement('option');
                option.value = classCode;
                option.textContent = `${classCode} - ${classInfo[classCode].name}`;
                classSelect.appendChild(option);
            });
        }

        // Thực hiện tìm kiếm
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const classFilter = document.getElementById('search-class-filter').value;
            const productFilter = document.getElementById('search-product-filter').value;

            // Lưu tìm kiếm gần đây
            if (searchTerm) {
                saveRecentSearch(searchTerm);
            }

            searchResults = [];

            Object.keys(classInfo).forEach(className => {
                if (classFilter && className !== classFilter) return;

                if (data[className]) {
                    Object.keys(data[className]).forEach(studentName => {
                        const student = data[className][studentName];
                        const hasProducts = student.products && student.products.length > 0;

                        // Áp dụng bộ lọc sản phẩm
                        if (productFilter === 'with-products' && !hasProducts) return;
                        if (productFilter === 'no-products' && hasProducts) return;

                        // Tìm kiếm trong tên, email, phone và tên sản phẩm
                        const matchesName = studentName.toLowerCase().includes(searchTerm);
                        const matchesEmail = student.email && student.email.toLowerCase().includes(searchTerm);
                        const matchesPhone = student.phone && student.phone.includes(searchTerm);

                        let matchesProduct = false;
                        if (student.products) {
                            matchesProduct = student.products.some(product =>
                                product.name.toLowerCase().includes(searchTerm) ||
                                product.idea.toLowerCase().includes(searchTerm) ||
                                product.classTask.toLowerCase().includes(searchTerm) ||
                                product.homework.toLowerCase().includes(searchTerm) ||
                                product.feedback.toLowerCase().includes(searchTerm)
                            );
                        }

                        if (!searchTerm || matchesName || matchesEmail || matchesPhone || matchesProduct) {
                            searchResults.push({
                                name: studentName,
                                class: className,
                                student: student,
                                matchType: getMatchType(searchTerm, studentName, student)
                            });
                        }
                    });
                }
            });

            displaySearchResults();
            updateSearchStats();
        }

        // Xác định loại match để highlight
        function getMatchType(searchTerm, studentName, student) {
            if (!searchTerm) return 'all';

            if (studentName.toLowerCase().includes(searchTerm)) return 'name';
            if (student.email && student.email.toLowerCase().includes(searchTerm)) return 'email';
            if (student.phone && student.phone.includes(searchTerm)) return 'phone';

            if (student.products && student.products.some(p =>
                p.name.toLowerCase().includes(searchTerm) ||
                p.idea.toLowerCase().includes(searchTerm) ||
                p.classTask.toLowerCase().includes(searchTerm) ||
                p.homework.toLowerCase().includes(searchTerm) ||
                p.feedback.toLowerCase().includes(searchTerm)
            )) {
                return 'product';
            }

            return 'none';
        }

        // Highlight text
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text;

            // escape các ký tự đặc biệt trong regex
            const escaped = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            const regex = new RegExp(`(${escaped})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }


        // Hiển thị kết quả tìm kiếm
        function displaySearchResults() {
            const container = document.getElementById('search-results');
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            if (searchResults.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i>😔</i>
                        <p>Không tìm thấy học viên nào phù hợp với từ khóa tìm kiếm</p>
                        <small>Hãy thử với từ khóa khác hoặc xóa bộ lọc</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            searchResults.forEach(result => {
                const div = document.createElement('div');
                div.className = 'student-card';
                div.onclick = () => {
                    currentClass = result.class;
                    showStudent(result.name);
                };

                const studentName = highlightText(result.name, searchTerm);
                const studentEmail = highlightText(result.student.email || 'Chưa có email', searchTerm);
                const studentPhone = highlightText(result.student.phone || 'Chưa có SĐT', searchTerm);

                let productInfo = '';
                if (result.matchType === 'product' && searchTerm) {
                    const matchingProducts = result.student.products.filter(p =>
                        p.name.toLowerCase().includes(searchTerm) ||
                        p.idea.toLowerCase().includes(searchTerm) ||
                        p.classTask.toLowerCase().includes(searchTerm) ||
                        p.homework.toLowerCase().includes(searchTerm) ||
                        p.feedback.toLowerCase().includes(searchTerm)
                    );

                    if (matchingProducts.length > 0) {
                        const productNames = matchingProducts.map(p => highlightText(p.name, searchTerm)).join(', ');
                        productInfo = `<p style="font-size: 0.9em; color: #666; margin-top: 5px;">📋 Sản phẩm: ${productNames}</p>`;
                    }
                }

                div.innerHTML = `
                    <div class="student-class-badge">${result.class}</div>
                    <h4>${studentName}</h4>
                    <p>${studentEmail}</p>
                    <p>${studentPhone}</p>
                    ${productInfo}
                    <div class="product-count">${result.student.products.length} sản phẩm</div>
                    <button class="btn btn-danger" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;" onclick="event.stopPropagation(); deleteStudentFromSearch('${result.class}', '${result.name}')">Xóa</button>
                `;

                container.appendChild(div);
            });
        }

        // Cập nhật thống kê tìm kiếm
        function updateSearchStats() {
            const stats = document.getElementById('search-stats');
            const searchTerm = document.getElementById('search-input').value.trim();
            const classFilter = document.getElementById('search-class-filter').value;
            const productFilter = document.getElementById('search-product-filter').value;

            let statsText = `Tìm thấy ${searchResults.length} học viên`;

            if (searchTerm) {
                statsText += ` với từ khóa "${searchTerm}"`;
            }

            if (classFilter) {
                statsText += ` trong lớp ${classFilter}`;
            }

            if (productFilter === 'with-products') {
                statsText += ` có sản phẩm`;
            } else if (productFilter === 'no-products') {
                statsText += ` chưa có sản phẩm`;
            }

            stats.textContent = statsText;
        }

        // Xóa bộ lọc tìm kiếm
        function clearSearchFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-class-filter').value = '';
            document.getElementById('search-product-filter').value = '';
            performSearch();
        }

        // Xóa học viên từ trang tìm kiếm
        function deleteStudentFromSearch(className, studentName) {
            if (confirm(`Bạn có chắc muốn xóa học viên ${studentName} khỏi lớp ${className}?`)) {
                delete data[className][studentName];
                saveToLocalStorage(); // Lưu vào localStorage
                updateStudentCounts();
                performSearch(); // Cập nhật lại kết quả tìm kiếm
            }
        }

        // Hiển thị trang tìm kiếm
        function showSearchPage() {
            hideAllPages();
            document.getElementById('search-page').classList.remove('hidden');
            setActiveNav(2);
            updateSearchFilters();
            performSearch(); // Hiển thị tất cả học viên ban đầu
        }

        // ======================== NAVIGATION FUNCTIONS ========================

        // Render lại grid các lớp học
        function renderClassGrid() {
            const grid = document.getElementById('class-grid');
            grid.innerHTML = '';

            const sections = {
                robotic: { title: 'Robotic', element: null },
                coding: { title: 'Coding', element: null }
            };

            Object.keys(sections).forEach(key => {
                const title = document.createElement('h3');
                title.textContent = sections[key].title;
                title.className = 'class-section-title';
                grid.appendChild(title);

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'class-grid-section';
                sectionDiv.id = `${key}-section`;
                grid.appendChild(sectionDiv);
                sections[key].element = sectionDiv;
            });

            Object.keys(classInfo).forEach(classCode => {
                const classData = classInfo[classCode];
                const type = classData.type || 'coding';
                const section = sections[type].element;
                const div = document.createElement('div');
                div.className = 'class-card';
                div.onclick = () => showClass(classCode);

                div.innerHTML = `
                    <h3>${classCode}</h3>
                    <p>${classData.name}</p>
                    <small style="color: #666;">${classData.description || ''}</small>
                    <button class="btn btn-danger" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;" onclick="event.stopPropagation(); deleteClass('${classCode}')">Xóa lớp</button>
                `;

                section.appendChild(div);
            });
        }

        // Hiển thị trang chủ
        function showHome() {
            hideAllPages();
            document.getElementById('home-page').classList.remove('hidden');
            setActiveNav(0);
            updateStudentCounts();
            renderClassGrid();
        }

        // Hiển thị trang lớp học
        function showClass(className) {
            currentClass = className;
            hideAllPages();
            document.getElementById('class-page').classList.remove('hidden');
            document.getElementById('class-title').textContent = `Lớp ${className} - ${classInfo[className].name}`;
            document.getElementById('class-comment').value = classInfo[className].comment || '';
            displayStudents();
        }

        // Hiển thị trang học viên
        function showStudent(studentName) {
            currentStudent = studentName;
            hideAllPages();
            document.getElementById('student-page').classList.remove('hidden');
            document.getElementById('student-title').textContent = `Sản phẩm của ${studentName} - Lớp ${currentClass}`;
            displayProducts();
        }

        // Hiển thị tất cả học viên
        function showAllStudents() {
            hideAllPages();
            document.getElementById('all-students-page').classList.remove('hidden');
            setActiveNav(1);
            displayAllStudents();
        }

        // Ẩn tất cả trang
        function hideAllPages() {
            const pages = ['home-page', 'class-page', 'student-page', 'all-students-page', 'search-page'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // Set active navigation
        function setActiveNav(index) {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach((btn, i) => {
                if (i === index) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ======================== CLASS MANAGEMENT ========================

        // Thêm lớp học mới
        function showAddClassModal() {
            document.getElementById('add-class-modal').style.display = 'block';
            clearClassForm();
        }

        function clearClassForm() {
            document.getElementById('class-code').value = '';
            document.getElementById('class-name').value = '';
            document.getElementById('class-type').value = 'coding';
            document.getElementById('class-description').value = '';
        }

        function addClass() {
            const code = document.getElementById('class-code').value.trim().toUpperCase();
            const name = document.getElementById('class-name').value.trim();
            const description = document.getElementById('class-description').value.trim();
            const type = document.getElementById('class-type').value;

            if (!code || !name) {
                alert('Vui lòng nhập mã lớp và tên lớp!');
                return;
            }

            if (classInfo[code]) {
                alert('Mã lớp đã tồn tại!');
                return;
            }

            classInfo[code] = {
                name: name,
                description: description,
                type: type,
                comment: ''
            };

            data[code] = {};

            saveToLocalStorage(); // Lưu vào localStorage

            closeModal('add-class-modal');
            renderClassGrid();
            updateStudentCounts();
            updateImportClassSelect();
            updateSearchFilters();
        }

        // Xóa lớp học
        function deleteClass(classCode) {
            if (confirm(`Bạn có chắc muốn xóa lớp ${classCode}? Tất cả dữ liệu học viên sẽ bị mất!`)) {
                delete classInfo[classCode];
                delete data[classCode];

                saveToLocalStorage(); // Lưu vào localStorage

                renderClassGrid();
                updateStudentCounts();
                updateImportClassSelect();
                updateSearchFilters();
            }
        }

        function saveClassComment() {
            if (!classInfo[currentClass]) return;
            classInfo[currentClass].comment = document.getElementById('class-comment').value.trim();
            saveToLocalStorage();
        }

        // ======================== STUDENT MANAGEMENT ========================

        // Cập nhật danh sách lớp trong select import
        function updateImportClassSelect() {
            const select = document.getElementById('import-class');
            select.innerHTML = '';

            Object.keys(classInfo).forEach(classCode => {
                const option = document.createElement('option');
                option.value = classCode;
                option.textContent = `${classCode} - ${classInfo[classCode].name}`;
                select.appendChild(option);
            });
        }

        // Quay lại trang lớp
        function goBackToClass() {
            showClass(currentClass);
        }

        // Cập nhật số lượng học viên
        function updateStudentCounts() {
            Object.keys(classInfo).forEach(className => {
                const count = data[className] ? Object.keys(data[className]).length : 0;
                const countElement = document.getElementById(`count-${className}`);
                if (countElement) {
                    countElement.textContent = `${count} học viên`;
                }
            });
        }

        // Hiển thị form thêm học viên
        function showAddStudentForm() {
            document.getElementById('add-student-modal').style.display = 'block';
            clearStudentForm();
        }

        // Xóa form học viên
        function clearStudentForm() {
            document.getElementById('student-name').value = '';
            document.getElementById('student-email').value = '';
            document.getElementById('student-phone').value = '';
        }

        // Thêm học viên
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const email = document.getElementById('student-email').value.trim();
            const phone = document.getElementById('student-phone').value.trim();

            if (!name) {
                alert('Vui lòng nhập tên học viên!');
                return;
            }

            if (data[currentClass][name]) {
                alert('Học viên đã tồn tại!');
                return;
            }

            data[currentClass][name] = {
                email: email,
                phone: phone,
                products: []
            };

            saveToLocalStorage(); // Lưu vào localStorage

            closeModal('add-student-modal');
            displayStudents();
            updateStudentCounts();
        }

        // Hiển thị danh sách học viên
        function displayStudents() {
            const container = document.getElementById('students-list');
            container.innerHTML = '';

            Object.keys(data[currentClass]).forEach(studentName => {
                const student = data[currentClass][studentName];
                const div = document.createElement('div');
                div.className = 'student-card';
                div.onclick = () => showStudent(studentName);

                div.innerHTML = `
                    <h4>${studentName}</h4>
                    <p>${student.email || 'Chưa có email'}</p>
                    <p>${student.phone || 'Chưa có SĐT'}</p>
                    <div class="product-count">${student.products.length} sản phẩm</div>
                    <button class="btn btn-danger" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;" onclick="event.stopPropagation(); deleteStudent('${studentName}')">Xóa</button>
                `;

                container.appendChild(div);
            });
        }

        // Hiển thị tất cả học viên
        function displayAllStudents() {
            const container = document.getElementById('all-students-list');
            container.innerHTML = '';

            Object.keys(classInfo).forEach(className => {
                if (data[className]) {
                    Object.keys(data[className]).forEach(studentName => {
                        const student = data[className][studentName];
                        const div = document.createElement('div');
                        div.className = 'student-card';
                        div.onclick = () => {
                            currentClass = className;
                            showStudent(studentName);
                        };

                        div.innerHTML = `
                            <div class="student-class-badge">${className}</div>
                            <h4>${studentName}</h4>
                            <p>${student.email || 'Chưa có email'}</p>
                            <div class="product-count">${student.products.length} sản phẩm</div>
                        `;

                        container.appendChild(div);
                    });
                }
            });
        }

        // Xóa học viên
        function deleteStudent(studentName) {
            if (confirm(`Bạn có chắc muốn xóa học viên ${studentName}?`)) {
                delete data[currentClass][studentName];
                saveToLocalStorage(); // Lưu vào localStorage
                displayStudents();
                updateStudentCounts();
            }
        }

        // ======================== PRODUCT MANAGEMENT ========================

        function getFeedbackTemplate() {
            const type = classInfo[currentClass]?.type;
            if (type === 'robotic') {
                return `Khả năng lắp ráp: Con lắp ráp tốt, tuân thủ đúng các bước và đảm bảo sản phẩm vận hành ổn định.\nLập trình: Con lập trình đúng theo yêu cầu, ít mắc lỗi và biết điều chỉnh khi robot chưa hoạt động như mong muốn.\nThái độ học tập: Con tập trung, nghiêm túc và hoàn thành tốt nội dung buổi học.\nLàm việc nhóm: Con làm việc nhóm tốt, hỗ trợ và phối hợp với các bạn để đạt kết quả chung.`;
            }
            return `Khả năng học tập: Trong buổi học hôm nay con tập trung khá tốt, tương tác tốt với thầy để xây dựng bài giảng, trong quá trình học con nên chủ động hơn khi chưa hiểu hoặc gặp sai sót. Con tiếp thu được kiến thức trong buổi học.\nKhả năng lập trình: Con lập trình được cú pháp cơ bản của List, trong quá trình lập trình con cần kiểm tra kĩ hơn để tránh bị sai lỗi cú pháp ( chính tả), trong quá trình làm bài tập con cần phân tích kĩ hơn, con hoàn thành nội dung buổi học.\nKhả năng ứng dung: Con ứng dụng được các bài tập cơ bản, đối với kiến thức mới còn còn gặp một số sai sót nhỏ và cần thầy hỗ trợ, về nhà con cố gắng ôn tập và làm bài tập để vững kiến thức hơn nhé.\nBài tập về nhà: Con hoàn thành đầy đủ bài tập về nhà`;
        }

        // Hiển thị form thêm sản phẩm
        function showAddProductForm() {
            editingProductIndex = -1;
            document.getElementById('product-modal-title').textContent = 'Thêm sản phẩm mới';
            document.getElementById('save-product-btn').textContent = 'Thêm sản phẩm';
            clearProductForm();
            document.getElementById('product-feedback').value = getFeedbackTemplate();
            document.getElementById('add-product-modal').style.display = 'block';
        }

        // Hiển thị form sửa sản phẩm
        function showEditProductForm(index) {
            editingProductIndex = index;
            const product = data[currentClass][currentStudent].products[index];

            document.getElementById('product-modal-title').textContent = 'Sửa sản phẩm';
            document.getElementById('save-product-btn').textContent = 'Cập nhật sản phẩm';

            document.getElementById('product-session').value = product.session;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-idea').value = product.idea;
            document.getElementById('product-class-task').value = product.classTask;
            document.getElementById('product-homework').value = product.homework;
            document.getElementById('product-progress').value = product.progress;
            document.getElementById('product-feedback').value = product.feedback;

            document.getElementById('add-product-modal').style.display = 'block';
        }

        // Xóa form sản phẩm
        function clearProductForm() {
            document.getElementById('product-session').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-idea').value = '';
            document.getElementById('product-class-task').value = '';
            document.getElementById('product-homework').value = '';
            document.getElementById('product-progress').value = '0';
            document.getElementById('product-feedback').value = '';
        }

        // Lưu sản phẩm
        function saveProduct() {
            const product = {
                session: parseInt(document.getElementById('product-session').value),
                name: document.getElementById('product-name').value.trim(),
                idea: document.getElementById('product-idea').value.trim(),
                classTask: document.getElementById('product-class-task').value.trim(),
                homework: document.getElementById('product-homework').value.trim(),
                progress: parseInt(document.getElementById('product-progress').value),
                feedback: document.getElementById('product-feedback').value.trim()
            };

            if (!product.name || !product.session) {
                alert('Vui lòng nhập tên sản phẩm và buổi học!');
                return;
            }

            if (editingProductIndex === -1) {
                // Thêm mới
                data[currentClass][currentStudent].products.push(product);
            } else {
                // Cập nhật
                data[currentClass][currentStudent].products[editingProductIndex] = product;
            }

            saveToLocalStorage(); // Lưu vào localStorage

            closeModal('add-product-modal');
            displayProducts();
        }

        // Hiển thị danh sách sản phẩm
        function displayProducts() {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = '';

            const products = data[currentClass][currentStudent].products;
            products.sort((a, b) => a.session - b.session); // Sắp xếp theo buổi học

            products.forEach((product, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>Buổi ${product.session}</td>
                    <td>${product.name}</td>
                    <td>${product.idea}</td>
                    <td>${product.classTask}</td>
                    <td>${product.homework}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${product.progress}%">
                                ${product.progress}%
                            </div>
                        </div>
                    </td>
                    <td>${product.feedback.replace(/\n/g, '<br>')}</td>
                    <td>
                        <button class="btn" style="font-size: 12px; padding: 5px 10px;" onclick="showEditProductForm(${index})">Sửa</button>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteProduct(${index})">Xóa</button>
                    </td>
                `;
            });
        }

        // Xóa sản phẩm
        function deleteProduct(index) {
            if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                data[currentClass][currentStudent].products.splice(index, 1);
                saveToLocalStorage(); // Lưu vào localStorage
                displayProducts();
            }
        }

        // ======================== MODAL FUNCTIONS ========================

        // Đóng modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Hiển thị modal import
        function showImportModal() {
            document.getElementById('import-modal').style.display = 'block';
            updateImportClassSelect();
            document.getElementById('excel-file').value = '';
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('import-btn').disabled = true;
            pendingImportData = null;
        }

        // Hiển thị hướng dẫn format Excel
        function showFormatGuide() {
            document.getElementById('format-guide-modal').style.display = 'block';
        }

        // ======================== EXCEL FUNCTIONS ========================

        // Tải file mẫu Excel
        function downloadTemplate() {
            const templateData = [
                ['Tên học viên', 'Email', 'Số điện thoại', 'Buổi học', 'Tên sản phẩm', 'Ý tưởng', 'Nhiệm vụ buổi học', 'Nhiệm vụ về nhà', 'Tiến độ (%)', 'Góp ý'],
                ['Nguyễn Văn A', 'nguyenvana@email.com', '0123456789', '1', 'Calculator App', 'Ứng dụng máy tính đơn giản', 'Học syntax Python cơ bản', 'Hoàn thành phép cộng, trừ', '75', 'Làm tốt, cần cải thiện giao diện'],
                ['Nguyễn Văn A', 'nguyenvana@email.com', '0123456789', '2', 'To-Do List', 'Ứng dụng quản lý công việc', 'Học về list và loop', 'Thêm chức năng xóa task', '50', 'Cần thêm validation'],
                ['Trần Thị B', 'tranthib@email.com', '0987654321', '', '', '', '', '', '', ''],
                ['Lê Văn C', 'levanc@email.com', '0369852147', '1', 'Interactive Website', 'Trang web tương tác với JavaScript', 'Học DOM manipulation', 'Thêm animation', '60', 'Tốt, cần chú ý responsive design']
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'Template_Import_Students.xlsx');
        }

        // Xử lý upload file Excel
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('File Excel phải có ít nhất 2 dòng (header và dữ liệu)');
                        return;
                    }

                    // Parse dữ liệu
                    const parsedData = parseExcelData(jsonData);
                    if (parsedData && parsedData.length > 0) {
                        pendingImportData = parsedData;
                        showPreview(parsedData);
                        document.getElementById('import-btn').disabled = false;
                    } else {
                        alert('Không thể đọc dữ liệu từ file Excel');
                    }

                } catch (error) {
                    alert('Lỗi khi đọc file Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse dữ liệu Excel
        function parseExcelData(jsonData) {
            const students = {};

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];

                // Bỏ qua dòng trống
                if (!row[0] || row[0].toString().trim() === '') continue;

                const studentName = row[0].toString().trim();
                const email = row[1] ? row[1].toString().trim() : '';
                const phone = row[2] ? row[2].toString().trim() : '';

                // Khởi tạo học viên nếu chưa có
                if (!students[studentName]) {
                    students[studentName] = {
                        email: email,
                        phone: phone,
                        products: []
                    };
                }

                // Thêm sản phẩm nếu có dữ liệu
                if (row[3] && row[4]) { // Có buổi học và tên sản phẩm
                    const session = parseInt(row[3]);
                    if (isNaN(session) || session < 1) {
                        console.warn(`Buổi học không hợp lệ cho ${studentName}: ${row[3]}`);
                        continue;
                    }

                    let progress = 0;
                    if (row[8]) {
                        progress = parseInt(row[8]);
                        if (isNaN(progress) || progress < 0 || progress > 100) {
                            progress = 0;
                        }
                    }

                    const product = {
                        session: session,
                        name: row[4] ? row[4].toString().trim() : '',
                        idea: row[5] ? row[5].toString().trim() : '',
                        classTask: row[6] ? row[6].toString().trim() : '',
                        homework: row[7] ? row[7].toString().trim() : '',
                        progress: progress,
                        feedback: row[9] ? row[9].toString().trim() : ''
                    };

                    students[studentName].products.push(product);
                }
            }

            return Object.keys(students).map(name => ({
                name: name,
                ...students[name]
            }));
        }

        // Hiển thị preview dữ liệu
        function showPreview(studentsData) {
            const container = document.getElementById('preview-container');

            let html = `
                <h4>Preview dữ liệu (${studentsData.length} học viên):</h4>
                <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                    <table class="product-table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Tên học viên</th>
                                <th>Email</th>
                                <th>SĐT</th>
                                <th>Số sản phẩm</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            studentsData.forEach(student => {
                html += `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.phone}</td>
                        <td>${student.products.length}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Import dữ liệu vào hệ thống
        function importData() {
            if (!pendingImportData) {
                alert('Không có dữ liệu để import');
                return;
            }

            const selectedClass = document.getElementById('import-class').value;
            const overwrite = document.getElementById('overwrite-data').checked;

            if (!selectedClass) {
                alert('Vui lòng chọn lớp để import');
                return;
            }

            // Xóa dữ liệu cũ nếu chọn ghi đè
            if (overwrite) {
                data[selectedClass] = {};
            }

            let importedCount = 0;
            let updatedCount = 0;

            pendingImportData.forEach(studentData => {
                if (data[selectedClass][studentData.name]) {
                    // Học viên đã tồn tại
                    if (overwrite) {
                        data[selectedClass][studentData.name] = {
                            email: studentData.email,
                            phone: studentData.phone,
                            products: studentData.products
                        };
                        updatedCount++;
                    } else {
                        // Merge sản phẩm mới
                        const existingProducts = data[selectedClass][studentData.name].products;
                        studentData.products.forEach(newProduct => {
                            // Kiểm tra xem sản phẩm đã tồn tại chưa (cùng session và tên)
                            const existingProduct = existingProducts.find(p =>
                                p.session === newProduct.session && p.name === newProduct.name
                            );

                            if (!existingProduct) {
                                existingProducts.push(newProduct);
                            }
                        });
                        updatedCount++;
                    }
                } else {
                    // Học viên mới
                    data[selectedClass][studentData.name] = {
                        email: studentData.email,
                        phone: studentData.phone,
                        products: studentData.products
                    };
                    importedCount++;
                }
            });

            saveToLocalStorage(); // Lưu vào localStorage

            closeModal('import-modal');
            updateStudentCounts();
            renderClassGrid();

            alert(`Import thành công!\n- ${importedCount} học viên mới\n- ${updatedCount} học viên được cập nhật`);
        }

        // Xuất dữ liệu Excel - Tất cả
        function exportData() {
            const wb = XLSX.utils.book_new();

            Object.keys(classInfo).forEach(className => {
                if (data[className]) {
                    const worksheetData = [];
                    worksheetData.push(['Tên học viên', 'Email', 'Số điện thoại', 'Buổi học', 'Tên sản phẩm', 'Ý tưởng', 'Nhiệm vụ buổi học', 'Nhiệm vụ về nhà', 'Tiến độ (%)', 'Góp ý']);

                    Object.keys(data[className]).forEach(studentName => {
                        const student = data[className][studentName];
                        if (student.products.length === 0) {
                            worksheetData.push([studentName, student.email, student.phone, '', '', '', '', '', '', '']);
                        } else {
                            student.products.forEach(product => {
                                worksheetData.push([
                                    studentName,
                                    student.email,
                                    student.phone,
                                    product.session,
                                    product.name,
                                    product.idea,
                                    product.classTask,
                                    product.homework,
                                    product.progress,
                                    product.feedback
                                ]);
                            });
                        }
                    });

                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    XLSX.utils.book_append_sheet(wb, ws, className);
                }
            });

            XLSX.writeFile(wb, `Danh_sach_hoc_vien_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Xuất dữ liệu lớp
        function exportClassData() {
            const worksheetData = [];
            worksheetData.push(['Tên học viên', 'Email', 'Số điện thoại', 'Buổi học', 'Tên sản phẩm', 'Ý tưởng', 'Nhiệm vụ buổi học', 'Nhiệm vụ về nhà', 'Tiến độ (%)', 'Góp ý']);

            Object.keys(data[currentClass]).forEach(studentName => {
                const student = data[currentClass][studentName];
                if (student.products.length === 0) {
                    worksheetData.push([studentName, student.email, student.phone, '', '', '', '', '', '', '']);
                } else {
                    student.products.forEach(product => {
                        worksheetData.push([
                            studentName,
                            student.email,
                            student.phone,
                            product.session,
                            product.name,
                            product.idea,
                            product.classTask,
                            product.homework,
                            product.progress,
                            product.feedback
                        ]);
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(wb, ws, currentClass);

            XLSX.writeFile(wb, `Lop_${currentClass}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Xuất dữ liệu học viên
        function exportStudentData() {
            const worksheetData = [];
            worksheetData.push(['Buổi học', 'Tên sản phẩm', 'Ý tưởng', 'Nhiệm vụ buổi học', 'Nhiệm vụ về nhà', 'Tiến độ (%)', 'Góp ý']);

            const student = data[currentClass][currentStudent];
            student.products.forEach(product => {
                worksheetData.push([
                    product.session,
                    product.name,
                    product.idea,
                    product.classTask,
                    product.homework,
                    product.progress,
                    product.feedback
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'San_pham');

            XLSX.writeFile(wb, `${currentStudent}_${currentClass}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ======================== EVENT LISTENERS ========================

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Đóng modal khi click outside
            window.onclick = function (event) {
                const modals = document.getElementsByClassName('modal');
                Array.from(modals).forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };

            // Khởi tạo ứng dụng
            init();
        });

        // Thêm các phím tắt
        document.addEventListener('keydown', function (e) {
            // ESC để đóng modal
            if (e.key === 'Escape') {
                const modals = document.getElementsByClassName('modal');
                Array.from(modals).forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }

            // Ctrl + F để focus vào ô tìm kiếm
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                const searchInput = document.getElementById('search-input');
                if (!document.getElementById('search-page').classList.contains('hidden')) {
                    searchInput.focus();
                } else {
                    showSearchPage();
                    setTimeout(() => searchInput.focus(), 100);
                }
            }

            // Ctrl + S để lưu khi đang trong form
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const productModal = document.getElementById('add-product-modal');
                const studentModal = document.getElementById('add-student-modal');
                const classModal = document.getElementById('add-class-modal');

                if (productModal.style.display === 'block') {
                    saveProduct();
                } else if (studentModal.style.display === 'block') {
                    addStudent();
                } else if (classModal.style.display === 'block') {
                    addClass();
                }
            }
        });
    </script>
</body>

</html>